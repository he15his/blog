# HTTPS 密钥协商过程



1. 客户端发出握手请求(Client Hello)，包含以下信息：

   * 支持的协议版本，比如TLS 1.0版。

   - 一个客户端生成的随机数(random_1)，这个随机数既需要客户端保存又需要发送给服务器。

   - 支持的加密方法，比如RSA公钥加密。

   - 支持的压缩方法。

     

2. 服务器回复(Server Hello)，包含以下信息：

   * 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。

   - 一个服务器生成的随机数(random_2)。

   - 确认使用的加密方法，比如RSA公钥加密。

   - 服务器证书。

   - 如果服务器需要确认客户端的身份，就会再包含一项请求，要求客户端提供”客户端证书”。比如，金融机构往往只允许认证客户连入自己的网络，就会向正式客户提供USB密钥，里面就包含了一张客户端证书。

     

3. 客户端回应，包含以下步骤：

   * 验证服务器证书的合法性，证书合法性包括：证书是否过期，发行服务器证书的 CA 是否可靠，发行者证书的公钥能否正确解开服务器证书的“发行者的数字签名”，服务器证书上的域名是否和服务器的实际域名相匹配。如果合法性验证没有通过，通讯将断开；

   - 客户端使用一些加密算法(例如：RSA,Diffie-Hellman)产生一个48个字节的Key，这个Key叫PreMaster Secret。**该PreMaster Secret用服务器公钥加密传送，防止被窃听**。

   - 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。

   - 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。

   - 如果前一步，服务器要求客户端证书，客户端会在这一步发送证书及相关信息。

     

4. 服务器回应，服务器通过上面的三个随机数(random_1,random_2,PreMaster Secret)，计算出本次会话的『会话密钥(session secret)』，然后向客户端发送下面信息

   * 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。

   - 服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。

至此，服务器和客户端的握手阶段全部结束，接下来，客户端与服务器进入加密通信，就完全是使用普通的HTTP协议，只不过用『会话密钥(session secret)』对内容做对称加密。